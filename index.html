<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>播磨陰陽道自分暦</title>
        <style type="text/css">
#koyomi {
    border: 1px solid red;
    margin: 0 auto;
    width:  400px;
    height: 400px;
}
        </style>
        <script type="text/javascript">
function MyKoyomiView(id, x, y, size, myKoyomi) {
    this.elt = document.getElementById(id);
    this.x = x;
    this.y = y;
    this.size = size;
    this.mine = myKoyomi;
    this.others = [];
}
MyKoyomiView.prototype = {
    add: function (aOther) {
        this.others.push(aOther);
        aOther.parent = this.mine;
    },
    remove: function (aOther) {
        this.other.remove(aOther);
        aOther.parent = null;
    },
    draw: function () {
        var ctx = this.elt.getContext('2d');
        // for retina
        ctx.scale(2, 2);

        var koyomis = [this.mine].concat(this.others);
        for (var item of koyomis) {
            item.draw(ctx, this.x, this.y, this.size);
        }

        for (var i = 0; i < 12; ++i) {
            this.putLabel(ctx, i * 360 / 12, (i + this.mine.baseMonth() - 1) % 12 + 1);
        }
    },
    putLabel: function (ctx, degree, label) {
        var rad = 2 * Math.PI * (-.25 + degree / 360);
        var fontSize = Math.ceil(20 / 300 * this.size);
        ctx.font = fontSize + 'px serif';
        var textSize = ctx.measureText(label);
        var len = this.size / 3 + fontSize;
        var x = this.x + this.size / 2 + len * Math.cos(rad) - textSize.width / 2;
        var y = this.y + this.size / 2 + len * Math.sin(rad) + fontSize / 2;
        ctx.fillStyle = 'black';
        ctx.fillText(label, x, y);
    },
};
function OnesKoyomi(birthMonth, ratio) {
    this.parent = null;
    this.birthMonth = birthMonth;
    this.ratio = ratio;
}
OnesKoyomi.prototype = {
    baseMonth: function () {
        if (this.parent) {
            return this.parent.birthMonth;
        }
        return this.birthMonth;
    },
    draw: function (ctx, x, y, size) {
        ctx.beginPath();
        ctx.arc(
            x + size / 2,
            y + size / 2,
            size / 3,
            0, 2 * Math.PI);
        ctx.closePath();
        ctx.stroke();

        var adjustment = this.birthMonth - this.baseMonth();
        var from = (7 - 12 + adjustment) % 12;
        var to   = adjustment;
        this.pie(ctx, x, y, size, from * 360 / 12, to * 360 / 12, true);
    },
    pie: function (ctx, x, y, size, start, end, fill) {
        ctx.fillStyle = 'rgba(0, 0, 0, ' + this.ratio + ')';
        ctx.beginPath();
        ctx.moveTo(
            x + size / 2,
            y + size / 2);
        ctx.arc(
            x + size / 2,
            y + size / 2,
            size / 3,
            (-.25 + start / 360) * 2 * Math.PI,
            (-.25 + end   / 360) * 2 * Math.PI);
        ctx.fill();
    },
};
function main() {
    var view = new MyKoyomiView('koyomi', 0, 0, 300, new OnesKoyomi(11, 0.50));
    view.add(new OnesKoyomi(3, 0.25));
    view.add(new OnesKoyomi(6, 0.25));

    view.draw();
}
        </script>
    </head>
    <body onload="main();">
        <canvas id="koyomi" width="800" height="800" />
    </body>
</html>